<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>J.A.R.V.I.S | SENTIENT CORE V6</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&family=Cinzel:wght@500&display=swap');

        body { 
            margin: 0; overflow: hidden; background-color: #000103;
            font-family: 'Rajdhani', sans-serif; color: #00FFFF; user-select: none;
        }

        /* LAYERS */
        #vignette { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, transparent 35%, #000000 120%); pointer-events: none; z-index: 10; }
        #scanlines { position: absolute; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0) 50%, rgba(0,0,0,0.2) 50%); background-size: 100% 3px; pointer-events: none; z-index: 11; opacity: 0.2; }

        /* BOOT SCREEN */
        #boot-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }
        .reactor-loader {
            width: 150px; height: 150px; border-radius: 50%;
            border: 2px solid rgba(0, 255, 255, 0.1);
            position: relative; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
        }
        .reactor-ring {
            position: absolute; border-radius: 50%; border: 2px solid transparent;
            border-top-color: #00FFFF; border-bottom-color: #00FFFF;
            animation: spin 2s linear infinite;
        }
        .r1 { width: 100%; height: 100%; animation-duration: 3s; border-width: 2px; }
        .r2 { width: 70%; height: 70%; animation-duration: 1.5s; animation-direction: reverse; border-left-color: #00FFFF; border-right-color: #00FFFF; border-width: 3px; }
        .boot-title { margin-top: 40px; font-family: 'Cinzel', serif; font-size: 32px; letter-spacing: 10px; color: #FFFFFF; text-shadow: 0 0 15px #00FFFF; }
        .progress-container { width: 400px; height: 2px; background: #002233; margin-top: 15px; }
        .progress-bar { height: 100%; width: 0%; background: #00FFFF; box-shadow: 0 0 10px #00FFFF; transition: width 0.3s ease-out; }
        #boot-log { font-family: 'Share Tech Mono'; color: #0088ff; font-size: 14px; margin-top: 10px; height: 20px; letter-spacing: 2px; }

        /* UI LAYOUT */
        #ui-layer { 
            position: absolute; width: 100%; height: 100%; z-index: 20; padding: 40px; box-sizing: border-box; 
            opacity: 0; transition: opacity 1s ease-in; 
        }

        /* CORE CONTAINER */
        #core-wrapper {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            text-align: center;
            width: 600px; height: 600px;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            pointer-events: none;
        }
        
        #core-wrapper.slide-left {
            left: 25%; 
            transform: translate(-50%, -50%) scale(0.8); 
        }

        /* CONTENT PANEL */
        #content-panel {
            position: absolute;
            top: 15%; right: -60%; 
            width: 45%; height: 70%;
            background: rgba(5, 10, 15, 0.9);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-left: 3px solid #00FFFF;
            backdrop-filter: blur(15px);
            padding: 0;
            box-sizing: border-box;
            transition: right 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 0;
            display: flex; flex-direction: column;
            box-shadow: -15px 0 40px rgba(0,0,0,0.6);
            clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
            pointer-events: auto; /* Ensure interaction */
        }
        
        #content-panel.show {
            right: 5%;
            opacity: 1;
        }

        .panel-header { 
            font-family: 'Cinzel'; font-size: 18px; color: #fff; 
            background: linear-gradient(90deg, rgba(0, 255, 255, 0.1), transparent);
            padding: 15px 25px; 
            border-bottom: 1px solid rgba(0, 255, 255, 0.3); 
            display: flex; justify-content: space-between; 
            align-items: center;
            letter-spacing: 2px;
        }
        
        .panel-body { 
            flex: 1; 
            font-family: 'Share Tech Mono', monospace; 
            font-size: 14px; color: #ccffff; 
            padding: 25px;
            overflow-y: auto; 
            white-space: pre-wrap; 
            line-height: 1.5;
            user-select: text; /* ENABLE COPYING */
            cursor: text;
        }

        /* Copy Button */
        #copy-btn {
            font-family: 'Share Tech Mono';
            font-size: 12px;
            color: #00FFFF;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #00FFFF;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #copy-btn:hover {
            background: #00FFFF;
            color: #000;
            box-shadow: 0 0 10px #00FFFF;
        }
        #copy-btn:active {
            transform: scale(0.95);
        }

        /* Research Formatting */
        .research-mode .panel-header { border-bottom: 1px solid #00AAFF; background: linear-gradient(90deg, rgba(0, 170, 255, 0.15), transparent); }
        .research-content h1 { font-size: 22px; color: #00AAFF; border-bottom: 1px solid #00AAFF; padding-bottom: 5px; margin-top: 0; }
        
        .panel-body::-webkit-scrollbar { width: 6px; }
        .panel-body::-webkit-scrollbar-track { background: #000810; }
        .panel-body::-webkit-scrollbar-thumb { background: #005566; border-radius: 2px; }

        /* HUD ELEMENTS */
        #jarvis-text { font-family: 'Cinzel', serif; font-size: 42px; font-weight: 700; letter-spacing: 12px; color: #FFFFFF; text-shadow: 0 0 15px #00FFFF; transition: color 0.3s; margin-top: 20px;}
        #jarvis-sub { font-family: 'Share Tech Mono'; font-size: 14px; color: #00FFFF; letter-spacing: 4px; margin-top: 8px; text-transform: uppercase; opacity: 0.8; }

        /* PERIPHERAL UI */
        .corner { position: absolute; width: 30px; height: 30px; border-color: #00FFFF; border-style: solid; opacity: 0.6; box-shadow: 0 0 5px #00FFFF; }
        .tl { top: 30px; left: 30px; border-width: 2px 0 0 2px; }
        .tr { top: 30px; right: 30px; border-width: 2px 2px 0 0; }
        .bl { bottom: 30px; left: 30px; border-width: 0 0 2px 2px; }
        .br { bottom: 30px; right: 30px; border-width: 0 2px 2px 0; }

        .header-bar { position: absolute; top: 30px; left: 30px; right: 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0, 255, 255, 0.15); padding-bottom: 10px; }
        
        .sys-log-container { position: absolute; bottom: 50px; left: 50px; width: 300px; pointer-events: none; }
        .terminal-box { height: 120px; overflow: hidden; font-family: 'Share Tech Mono'; font-size: 10px; color: rgba(0,255,255,0.6); display: flex; flex-direction: column-reverse; border-left: 2px solid rgba(0, 255, 255, 0.2); padding-left: 10px;}
        .log-line { margin-bottom: 3px; padding-left: 5px; animation: slideIn 0.2s; text-shadow: 0 0 2px rgba(0,255,255,0.3); }

        #sys-status { font-weight: bold; color: #fff; }
        #activity-bar { width: 0%; height: 100%; background: #00FFFF; transition: width 0.2s; box-shadow: 0 0 10px #00FFFF; }

        #canvas-container { position: absolute; top: 0; left: 0; z-index: 1; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    
    <!-- BOOT SCREEN -->
    <div id="boot-layer">
        <div class="reactor-loader">
            <div class="reactor-ring r1"></div>
            <div class="reactor-ring r2"></div>
        </div>
        <div class="boot-title">J.A.R.V.I.S</div>
        <div class="progress-container">
            <div class="progress-bar" id="boot-bar"></div>
        </div>
        <div id="boot-log">INITIALIZING...</div>
    </div>

    <!-- MAIN UI -->
    <div id="canvas-container"></div>
    <div id="vignette"></div>
    <div id="scanlines"></div>

    <div id="ui-layer">
        <div class="corner tl"></div><div class="corner tr"></div>
        <div class="corner bl"></div><div class="corner br"></div>
        
        <div class="header-bar">
            <div class="hud-text"><span style="font-size: 20px; font-weight: bold; letter-spacing: 4px;">J.A.R.V.I.S</span><span class="mono-text" style="font-size: 10px; opacity: 0.7; margin-left:10px;">// SYSTEM_V5.0</span></div>
            <div class="hud-text mono-text" id="clock">00:00:00</div>
        </div>

        <div class="sys-log-container">
            <div class="hud-text" style="font-size: 10px; margin-bottom: 5px; opacity: 0.8;">LIVE FEED</div>
            <div class="terminal-box" id="terminal"></div>
        </div>

        <div style="position: absolute; bottom: 50px; right: 50px; width: 250px; text-align: right;">
            <div class="hud-text" style="font-size: 10px; margin-bottom: 5px; opacity: 0.8;">CORE STATUS</div>
            <div class="mono-text" style="font-size: 14px; margin-bottom: 5px;" id="sys-status">ONLINE</div>
            <div style="width:100%; height:3px; background:#002233;"><div id="activity-bar"></div></div>
        </div>

        <!-- MOVING CORE WRAPPER -->
        <div id="core-wrapper">
            <div style="height: 300px;"></div> 
            <div id="jarvis-text">J.A.R.V.I.S</div>
            <div id="jarvis-sub">AWAITING INPUT</div>
        </div>

        <!-- SLIDE-IN CONTENT PANEL -->
        <div id="content-panel">
            <div class="panel-header">
                <span id="panel-title">VISUAL FEED</span>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="copy-btn" onclick="copyContent()">[COPY]</button>
                    <span style="font-size:10px; color:#00FFFF; border:1px solid #00FFFF; padding: 2px 6px;">DATA</span>
                </div>
            </div>
            <div class="panel-body" id="panel-content"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        const ws = new WebSocket("ws://localhost:8765");
        const term = document.getElementById("terminal");
        const mainText = document.getElementById("jarvis-text");
        const subText = document.getElementById("jarvis-sub");
        const bootLayer = document.getElementById("boot-layer");
        const bootBar = document.getElementById("boot-bar");
        const bootLog = document.getElementById("boot-log");
        
        // Slide UI Elements
        const coreWrapper = document.getElementById("core-wrapper");
        const contentPanel = document.getElementById("content-panel");
        const panelContent = document.getElementById("panel-content");
        const panelTitle = document.getElementById("panel-title");
        const copyBtn = document.getElementById("copy-btn");
        const uiLayer = document.getElementById("ui-layer");

        let isReady = false;
        let contentTimer = null;

        // Copy Function
        window.copyContent = function() {
            const text = panelContent.innerText;
            if (!text) return;
            
            // Create temporary element to handle copy
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy'); // Legacy but reliable in webview
            document.body.removeChild(el);
            
            // Visual Feedback
            const originalText = copyBtn.innerText;
            copyBtn.innerText = "[COPIED]";
            copyBtn.style.background = "#00FF00";
            copyBtn.style.color = "#000";
            setTimeout(() => {
                copyBtn.innerText = originalText;
                copyBtn.style.background = "rgba(0, 255, 255, 0.1)";
                copyBtn.style.color = "#00FFFF";
            }, 1500);
        };

        ws.onopen = () => console.log("GUI Connected");
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.status === "BOOT") {
                bootLog.innerText = data.log;
                if(data.progress) bootBar.style.width = data.progress + "%";
            } else if (data.status === "READY" && !isReady) {
                unlockInterface();
            } else if (data.status === "SHOW_CONTENT") {
                unlockInterface(); // Force unlock if content shown
                showContent(data.text, data.log); 
            } else if (data.status === "HIDE_CONTENT") {
                hideContent();
            } else {
                unlockInterface(); // Force unlock on normal updates
                handleState(data);
            }
        };

        function unlockInterface() {
            if (!isReady) {
                isReady = true;
                bootBar.style.width = "100%";
                setTimeout(() => {
                    bootLayer.style.opacity = 0;
                    uiLayer.style.opacity = 1;
                    setTimeout(() => bootLayer.remove(), 1000);
                }, 800);
            }
        }

        function addLog(msg) {
            if(!msg) return;
            if(msg.includes("Executing") || msg.includes("Searching")) return;
            const div = document.createElement("div");
            div.className = "log-line";
            div.innerText = `> ${msg}`;
            term.prepend(div);
            if(term.children.length > 8) term.lastChild.remove();
        }

        function showContent(bodyText, titleText) {
            coreWrapper.classList.add("slide-left");
            contentPanel.classList.add("show");
            
            const isResearch = titleText.includes("RESEARCH") || titleText.includes("STUDY");
            if (isResearch) {
                contentPanel.className = "research-mode show";
                let html = bodyText.replace(/\*\*(.*?)\*\*/g, '<h1>$1</h1>').replace(/^\* (.*$)/gm, '<li>$1</li>').replace(/\n/g, '<br>');
                panelContent.innerHTML = `<div class='research-content'>${html}</div>`;
            } else {
                contentPanel.className = "show";
                panelContent.innerText = bodyText;
            }
            panelTitle.innerText = titleText || "SYSTEM OUTPUT";
        }

        function hideContent() {
            coreWrapper.classList.remove("slide-left");
            contentPanel.classList.remove("show");
        }

        function handleState(data) {
            if (typeof data.text !== 'undefined' && data.text.length > 0) {
                if (data.text.length > 30) subText.innerText = data.text.substring(0, 30) + "...";
                else subText.innerText = data.text;
            }
            
            if (data.log) addLog(data.log);

            switch(data.status) {
                case "SPEAKING":
                    mainText.style.color = "#FF3333";
                    mainText.style.textShadow = "0 0 30px #FF0000";
                    coreColor.setHex(0xFF0000);
                    break;
                case "LISTENING":
                    mainText.style.color = "#00FFFF";
                    mainText.style.textShadow = "0 0 30px #00FFFF";
                    coreColor.setHex(0x00FFFF);
                    break;
                case "THINKING":
                    mainText.style.color = "#FFD700";
                    mainText.style.textShadow = "0 0 30px #FFD700";
                    coreColor.setHex(0xFFD700);
                    break;
                default:
                    mainText.style.color = "#FFFFFF";
                    coreColor.setHex(0x0088FF);
            }
        }

        // --- THREE.JS V5 REACTOR ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000103, 0.02);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 60;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const core = new THREE.Group();
        scene.add(core);
        
        let coreColor = new THREE.Color(0x00FFFF);
        // Additive blending makes it glow
        const mat = (opacity) => new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: opacity, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });

        // 1. Center Sphere (Replaces Crystal)
        const sphereGeo = new THREE.SphereGeometry(2.5, 32, 32);
        const sphere = new THREE.Mesh(sphereGeo, mat(0.85));
        core.add(sphere);
        
        // 1b. Wireframe Overlay
        const wireGeo = new THREE.SphereGeometry(2.8, 16, 16);
        const wireMat = new THREE.MeshBasicMaterial({ color: 0x00FFFF, wireframe: true, transparent: true, opacity: 0.15 });
        const wireSphere = new THREE.Mesh(wireGeo, wireMat);
        core.add(wireSphere);

        // 2. Block Ring (Outer teeth)
        const blockRing = new THREE.Group();
        for(let i=0; i<36; i++) {
            const m = new THREE.Mesh(new THREE.PlaneGeometry(0.4, 0.15), mat(0.9));
            const a = (i/36) * Math.PI*2;
            m.position.set(Math.cos(a)*4.5, Math.sin(a)*4.5, 0);
            m.rotation.z = a - Math.PI/2;
            blockRing.add(m);
        }
        core.add(blockRing);

        // 3. Main Segments
        const segs = new THREE.Group();
        for(let i=0; i<3; i++) {
            segs.add(new THREE.Mesh(new THREE.RingGeometry(5.2, 6.0, 64, 1, i*Math.PI*2/3+0.1, Math.PI*2/3-0.2), mat(0.3)));
            segs.add(new THREE.Mesh(new THREE.RingGeometry(5.2, 5.25, 64, 1, i*Math.PI*2/3+0.1, Math.PI*2/3-0.2), mat(0.9)));
        }
        core.add(segs);

        // 4. Ruler Ring
        const ruler = new THREE.Group();
        const tickGeo = new THREE.PlaneGeometry(0.05, 0.4);
        for(let i=0; i<120; i++) {
            const m = new THREE.Mesh(tickGeo, mat(0.5));
            const a = (i/120) * Math.PI*2;
            m.position.set(Math.cos(a)*7, Math.sin(a)*7, 0);
            m.rotation.z = a - Math.PI/2;
            ruler.add(m);
        }
        core.add(ruler);

        // 5. Outer Ring
        const outer = new THREE.Group();
        outer.add(new THREE.Mesh(new THREE.RingGeometry(8, 8.05, 128), mat(0.4)));
        for(let i=0; i<4; i++) {
            outer.add(new THREE.Mesh(new THREE.RingGeometry(8, 8.25, 32, 1, i*Math.PI/2 - 0.2, 0.4), mat(0.8)));
        }
        core.add(outer);

        // 6. Orbiting Particles
        const particles = new THREE.Group();
        const pGeo = new THREE.SphereGeometry(0.1, 4, 4);
        for(let i=0; i<20; i++) {
            const p = new THREE.Mesh(pGeo, mat(0.6));
            const dist = 9 + Math.random() * 4;
            const angle = Math.random() * Math.PI * 2;
            p.position.set(Math.cos(angle)*dist, Math.sin(angle)*dist, (Math.random()-0.5)*2);
            particles.add(p);
        }
        core.add(particles);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.strength = 2.8; bloom.radius = 0.5; bloom.threshold = 0.05;
        composer.addPass(bloom);

        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            
            if (coreWrapper.classList.contains("slide-left")) {
                core.position.x += (-15 - core.position.x) * 0.1;
                core.scale.x += (0.7 - core.scale.x) * 0.1;
                core.scale.y += (0.7 - core.scale.y) * 0.1;
            } else {
                core.position.x += (0 - core.position.x) * 0.1;
                core.scale.x += (1 - core.scale.x) * 0.1;
                core.scale.y += (1 - core.scale.y) * 0.1;
            }

            // Core Dynamics
            core.traverse((c) => { if(c.isMesh) c.material.color.lerp(coreColor, 0.1); });
            
            // No scale pulse!
            
            // Rotation only
            sphere.rotation.y += 0.01;
            wireSphere.rotation.x -= 0.005;
            wireSphere.rotation.y += 0.005;
            blockRing.rotation.z -= 0.005;
            segs.rotation.z += 0.002;
            ruler.rotation.z -= 0.001;
            outer.rotation.z += 0.003;
            particles.rotation.z += 0.005;
            particles.rotation.y = Math.sin(time * 0.2) * 0.2;

            composer.render();
        }
        animate();

        setInterval(() => document.getElementById("clock").innerText = new Date().toLocaleTimeString(), 1000);
        window.onresize = () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>